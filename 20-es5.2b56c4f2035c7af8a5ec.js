function _createForOfIteratorHelper(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=_unsupportedIterableToArray(e))){var t=0,n=function(){};return{s:n,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s,r=!0,o=!1;return{s:function(){i=e[Symbol.iterator]()},n:function(){var e=i.next();return r=e.done,e},e:function(e){o=!0,s=e},f:function(){try{r||null==i.return||i.return()}finally{if(o)throw s}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{FAoz:function(e,t,n){!function(){function t(e){return Math.sqrt(e.x*e.x+e.y*e.y)}var n=function(e){this.handlers=[],this.el=e};function i(e,t){var i=new n(e);return i.add(t),i}n.prototype.add=function(e){this.handlers.push(e)},n.prototype.del=function(e){e||(this.handlers=[]);for(var t=this.handlers.length;t>=0;t--)this.handlers[t]===e&&this.handlers.splice(t,1)},n.prototype.dispatch=function(){for(var e=0,t=this.handlers.length;e<t;e++){var n=this.handlers[e];"function"==typeof n&&n.apply(this.el,arguments)}};var s=function(e,t){this.element="string"==typeof e?document.querySelector(e):e,this.start=this.start.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.cancel=this.cancel.bind(this),this.element.addEventListener("touchstart",this.start,!1),this.element.addEventListener("touchmove",this.move,!1),this.element.addEventListener("touchend",this.end,!1),this.element.addEventListener("touchcancel",this.cancel,!1),this.preV={x:null,y:null},this.pinchStartLen=null,this.zoom=1,this.isDoubleTap=!1;var n=function(){};this.rotate=i(this.element,t.rotate||n),this.touchStart=i(this.element,t.touchStart||n),this.multipointStart=i(this.element,t.multipointStart||n),this.multipointEnd=i(this.element,t.multipointEnd||n),this.pinch=i(this.element,t.pinch||n),this.swipe=i(this.element,t.swipe||n),this.tap=i(this.element,t.tap||n),this.doubleTap=i(this.element,t.doubleTap||n),this.longTap=i(this.element,t.longTap||n),this.singleTap=i(this.element,t.singleTap||n),this.pressMove=i(this.element,t.pressMove||n),this.twoFingerPressMove=i(this.element,t.twoFingerPressMove||n),this.touchMove=i(this.element,t.touchMove||n),this.touchEnd=i(this.element,t.touchEnd||n),this.touchCancel=i(this.element,t.touchCancel||n),this._cancelAllHandler=this.cancelAll.bind(this),window.addEventListener("scroll",this._cancelAllHandler),this.delta=null,this.last=null,this.now=null,this.tapTimeout=null,this.singleTapTimeout=null,this.longTapTimeout=null,this.swipeTimeout=null,this.x1=this.x2=this.y1=this.y2=null,this.preTapPosition={x:null,y:null}};s.prototype={start:function(e){if(e.touches){this.now=Date.now(),this.x1=e.touches[0].pageX,this.y1=e.touches[0].pageY,this.delta=this.now-(this.last||this.now),this.touchStart.dispatch(e,this.element),null!==this.preTapPosition.x&&(this.isDoubleTap=this.delta>0&&this.delta<=250&&Math.abs(this.preTapPosition.x-this.x1)<30&&Math.abs(this.preTapPosition.y-this.y1)<30,this.isDoubleTap&&clearTimeout(this.singleTapTimeout)),this.preTapPosition.x=this.x1,this.preTapPosition.y=this.y1,this.last=this.now;var n=this.preV;if(e.touches.length>1){this._cancelLongTap(),this._cancelSingleTap();var i={x:e.touches[1].pageX-this.x1,y:e.touches[1].pageY-this.y1};n.x=i.x,n.y=i.y,this.pinchStartLen=t(n),this.multipointStart.dispatch(e,this.element)}this._preventTap=!1,this.longTapTimeout=setTimeout((function(){this.longTap.dispatch(e,this.element),this._preventTap=!0}).bind(this),750)}},move:function(e){if(e.touches){var n=this.preV,i=e.touches.length,s=e.touches[0].pageX,r=e.touches[0].pageY;if(this.isDoubleTap=!1,i>1){var o=e.touches[1].pageX,a=e.touches[1].pageY,c={x:e.touches[1].pageX-s,y:e.touches[1].pageY-r};null!==n.x&&(this.pinchStartLen>0&&(e.zoom=t(c)/this.pinchStartLen,this.pinch.dispatch(e,this.element)),e.angle=(d=function(e,n){var i=t(e)*t(n);if(0===i)return 0;var s=function(e,t){return e.x*t.x+e.y*t.y}(e,n)/i;return s>1&&(s=1),Math.acos(s)}(u=c,g=n),function(e,t){return e.x*t.y-t.x*e.y}(u,g)>0&&(d*=-1),180*d/Math.PI),this.rotate.dispatch(e,this.element)),n.x=c.x,n.y=c.y,null!==this.x2&&null!==this.sx2?(e.deltaX=(s-this.x2+o-this.sx2)/2,e.deltaY=(r-this.y2+a-this.sy2)/2):(e.deltaX=0,e.deltaY=0),this.twoFingerPressMove.dispatch(e,this.element),this.sx2=o,this.sy2=a}else{if(null!==this.x2){e.deltaX=s-this.x2,e.deltaY=r-this.y2;var l=Math.abs(this.x1-this.x2),h=Math.abs(this.y1-this.y2);(l>10||h>10)&&(this._preventTap=!0)}else e.deltaX=0,e.deltaY=0;this.pressMove.dispatch(e,this.element)}this.touchMove.dispatch(e,this.element),this._cancelLongTap(),this.x2=s,this.y2=r,i>1&&e.preventDefault()}var u,g,d},end:function(e){if(e.changedTouches){this._cancelLongTap();var t=this;e.touches.length<2&&(this.multipointEnd.dispatch(e,this.element),this.sx2=this.sy2=null),this.x2&&Math.abs(this.x1-this.x2)>30||this.y2&&Math.abs(this.y1-this.y2)>30?(e.direction=this._swipeDirection(this.x1,this.x2,this.y1,this.y2),this.swipeTimeout=setTimeout((function(){t.swipe.dispatch(e,t.element)}),0)):(this.tapTimeout=setTimeout((function(){t._preventTap||t.tap.dispatch(e,t.element),t.isDoubleTap&&(t.doubleTap.dispatch(e,t.element),t.isDoubleTap=!1)}),0),t.isDoubleTap||(t.singleTapTimeout=setTimeout((function(){t.singleTap.dispatch(e,t.element)}),250))),this.touchEnd.dispatch(e,this.element),this.preV.x=0,this.preV.y=0,this.zoom=1,this.pinchStartLen=null,this.x1=this.x2=this.y1=this.y2=null}},cancelAll:function(){this._preventTap=!0,clearTimeout(this.singleTapTimeout),clearTimeout(this.tapTimeout),clearTimeout(this.longTapTimeout),clearTimeout(this.swipeTimeout)},cancel:function(e){this.cancelAll(),this.touchCancel.dispatch(e,this.element)},_cancelLongTap:function(){clearTimeout(this.longTapTimeout)},_cancelSingleTap:function(){clearTimeout(this.singleTapTimeout)},_swipeDirection:function(e,t,n,i){return Math.abs(e-t)>=Math.abs(n-i)?e-t>0?"Left":"Right":n-i>0?"Up":"Down"},on:function(e,t){this[e]&&this[e].add(t)},off:function(e,t){this[e]&&this[e].del(t)},destroy:function(){return this.singleTapTimeout&&clearTimeout(this.singleTapTimeout),this.tapTimeout&&clearTimeout(this.tapTimeout),this.longTapTimeout&&clearTimeout(this.longTapTimeout),this.swipeTimeout&&clearTimeout(this.swipeTimeout),this.element.removeEventListener("touchstart",this.start),this.element.removeEventListener("touchmove",this.move),this.element.removeEventListener("touchend",this.end),this.element.removeEventListener("touchcancel",this.cancel),this.rotate.del(),this.touchStart.del(),this.multipointStart.del(),this.multipointEnd.del(),this.pinch.del(),this.swipe.del(),this.tap.del(),this.doubleTap.del(),this.longTap.del(),this.singleTap.del(),this.pressMove.del(),this.twoFingerPressMove.del(),this.touchMove.del(),this.touchEnd.del(),this.touchCancel.del(),this.preV=this.pinchStartLen=this.zoom=this.isDoubleTap=this.delta=this.last=this.now=this.tapTimeout=this.singleTapTimeout=this.longTapTimeout=this.swipeTimeout=this.x1=this.x2=this.y1=this.y2=this.preTapPosition=this.rotate=this.touchStart=this.multipointStart=this.multipointEnd=this.pinch=this.swipe=this.tap=this.doubleTap=this.longTap=this.singleTap=this.pressMove=this.touchMove=this.touchEnd=this.touchCancel=this.twoFingerPressMove=null,window.removeEventListener("scroll",this._cancelAllHandler),null}},e.exports=s}()},"g+tZ":function(e,t,n){"use strict";n.r(t),n.d(t,"WorkPageModule",(function(){return Re}));var i=n("TEn/"),s=n("ofXK"),r=n("3Pt+"),o=n("tyNb"),a=n("mrSG"),c=n("BZV/"),l=n("6mc2"),h=n("fXoL"),u=n("jhN1"),g=n("PQoX"),d=["fileinput"];function p(e,t){if(1&e&&(h.Nb(0,"div",15),h.Nb(1,"div",16),h.Lb(2,"ion-icon",17),h.Nb(3,"div",18),h.pc(4),h.Mb(),h.Mb(),h.Mb()),2&e){var n=h.Xb();h.zb(2),h.cc("sortablejs",n.deletedimages)("sortablejsOptions",n.options),h.zb(2),h.qc(n.deletedimages.length)}}function f(e,t){1&e&&h.Lb(0,"ion-spinner")}function m(e,t){if(1&e&&(h.Nb(0,"div",19),h.nc(1,f,1,0,"ion-spinner",20),h.Mb()),2&e){var n=h.Xb();h.zb(1),h.cc("ngIf",n.processing)}}function b(e,t){if(1&e&&(h.Nb(0,"div"),h.Lb(1,"div",21),h.Mb()),2&e){var n=t.$implicit,i=h.Xb();h.zb(1),h.mc("background-image",i.imageMap.get(n).style,h.Db)}}var v,y=((v=function(){function e(t,n,i){var s=this;_classCallCheck(this,e),this.tools=t,this.sanitizer=n,this.modalCtrl=i,this.images=[],this.imagebackup=[],this.deletedimages=[],this.processing=!0,this.changed=!1,this.options={group:"pictures",onUpdate:function(e){if(s.images.length===s.imagebackup.length){for(var t=0;t<s.images.length;++t)if(s.images[t]!==s.imagebackup[t])return void(s.changed=!0);s.changed=!1}else s.changed=!0}},this.imageMap=new Map}return _createClass(e,[{key:"ngOnInit",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.files){e.next=2;break}throw new Error("Dragster files property requires FileList");case 2:this.importPhotos(this.files);case 3:case"end":return e.stop()}}),e,this)})))}},{key:"importPhotos",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,i,s,r,o,a,c,l,h,u;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.processing=!0,console.log("resizing",e.length,"files"),n=Array.from(this.files),i=[],s=0,r=n;case 3:if(!(s<r.length)){t.next=15;break}return o=r[s],console.log("resizing",o.name),t.next=8,this.tools.resizeImage(o);case 8:a=t.sent,console.log("resizing done"),c=URL.createObjectURL(a.blob),l=this.sanitizer.bypassSecurityTrustStyle("url("+c+")"),h=this.tools.makeObjectId(),(u=new Date(0)).setUTCMilliseconds(o.lastModified),this.imageMap.set(h,{blob:a.blob,width:a.width,height:a.height,style:l,date:u,name:o.name}),i.push(h);case 12:s++,t.next=3;break;case 15:this.images=[].concat(_toConsumableArray(this.images),i),this.imagebackup=this.images.slice(0),this.processing=!1;case 16:case"end":return t.stop()}}),t,this)})))}},{key:"reset",value:function(){this.images=this.imagebackup.slice(0),this.deletedimages=[]}},{key:"handleFiles",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.preventDefault(),0!==e.target.files.length?this.importPhotos(e.target.files):console.log("No files selected");case 1:case"end":return t.stop()}}),t,this)})))}},{key:"accept",value:function(){var e=this,t=this.images.map((function(t){var n=e.imageMap.get(t);return{date:n.date,name:n.name,width:n.width,height:n.height,blob:e.imageMap.get(t).blob}}));this.modalCtrl.dismiss({photos:t,coverIndex:0})}},{key:"close",value:function(){this.modalCtrl.dismiss()}}]),e}()).\u0275fac=function(e){return new(e||v)(h.Kb(l.a),h.Kb(u.b),h.Kb(i.x))},v.\u0275cmp=h.Eb({type:v,selectors:[["ng-component"]],viewQuery:function(e,t){var n;1&e&&h.lc(d,!0),2&e&&h.fc(n=h.Wb())&&(t.inputElement=n.first)},inputs:{files:"files"},decls:15,vars:6,consts:[["slot","icon-only","name","close",1,"closebutton",3,"click"],[1,"mainlayout"],["class","statusbar",4,"ngIf"],["class","loading",4,"ngIf"],[1,"scroller"],[1,"pics",3,"sortablejs","sortablejsOptions"],[4,"ngFor","ngForOf"],["vertical","bottom","horizontal","center","slot","fixed",1,"foo"],[3,"disabled","click"],["name","refresh"],["vertical","bottom","horizontal","end","slot","fixed",1,"foo"],[3,"click"],["name","checkmark-outline"],["multiple","","type","file","name","name","accept","image/*",2,"display","none",3,"change"],["fileinput",""],[1,"statusbar"],[1,"trashbox"],["name","trash-bin",3,"sortablejs","sortablejsOptions"],[1,"count"],[1,"loading"],[4,"ngIf"],[1,"image",2,"background-size","cover","background-position","center","background-repeat","no-repeat"]],template:function(e,t){1&e&&(h.Nb(0,"ion-icon",0),h.Vb("click",(function(){return t.close()})),h.Mb(),h.Nb(1,"div",1),h.nc(2,p,5,3,"div",2),h.nc(3,m,2,1,"div",3),h.Nb(4,"div",4),h.Nb(5,"div",5),h.nc(6,b,2,2,"div",6),h.Mb(),h.Mb(),h.Nb(7,"ion-fab",7),h.Nb(8,"ion-fab-button",8),h.Vb("click",(function(){return t.reset()})),h.Lb(9,"ion-icon",9),h.Mb(),h.Mb(),h.Nb(10,"ion-fab",10),h.Nb(11,"ion-fab-button",11),h.Vb("click",(function(){return t.accept()})),h.Lb(12,"ion-icon",12),h.Mb(),h.Mb(),h.Nb(13,"input",13,14),h.Vb("change",(function(e){return t.handleFiles(e)})),h.Mb(),h.Mb()),2&e&&(h.zb(2),h.cc("ngIf",!t.processing),h.zb(1),h.cc("ngIf",t.processing),h.zb(2),h.cc("sortablejs",t.images)("sortablejsOptions",t.options),h.zb(1),h.cc("ngForOf",t.images),h.zb(2),h.cc("disabled",!t.changed))},directives:[i.k,s.k,g.a,s.j,i.h,i.i,i.p],styles:['.mainlayout[_ngcontent-%COMP%]{width:100%;height:100%}.mainlayout[_ngcontent-%COMP%]   .statusbar[_ngcontent-%COMP%]{width:100%;max-width:100%;height:60px;display:flex;flex-direction:row;justify-content:space-between;align-items:flex-end;padding:5px}.mainlayout[_ngcontent-%COMP%]   .statusbar[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:40px;width:40px;height:40px;color:var(--ion-color-primary)}.mainlayout[_ngcontent-%COMP%]   .statusbar[_ngcontent-%COMP%]   ion-icon.disabled[_ngcontent-%COMP%]{opacity:.5}.mainlayout[_ngcontent-%COMP%]   .statusbar[_ngcontent-%COMP%]   .trashbox[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:flex-end;font-weight:700}.mainlayout[_ngcontent-%COMP%]   .statusbar[_ngcontent-%COMP%]   .trashbox[_ngcontent-%COMP%]   .count[_ngcontent-%COMP%]{color:var(--ion-color-primary)}.mainlayout[_ngcontent-%COMP%]   .loading[_ngcontent-%COMP%]{width:100%;height:60px;display:flex;flex-direction:row;justify-content:center;padding:5px}.mainlayout[_ngcontent-%COMP%]   .loading[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{width:40px;height:40px;--color:var(--ion-color-primary)}.mainlayout[_ngcontent-%COMP%]   .scroller[_ngcontent-%COMP%]{width:100%;height:calc(100% - 130px);margin-bottom:100px;overflow-y:scroll;overflow-x:hidden}.mainlayout[_ngcontent-%COMP%]   .scroller[_ngcontent-%COMP%]   .pics[_ngcontent-%COMP%]{display:grid;grid-template-columns:32vw 32vw 32vw;grid-template-rows:auto;grid-gap:2vw;-webkit-filter:drop-shadow(-1px 1px 3px grey);filter:drop-shadow(-1px 1px 3px grey)}.mainlayout[_ngcontent-%COMP%]   .scroller[_ngcontent-%COMP%]   .pics[_ngcontent-%COMP%]   .image[_ngcontent-%COMP%]{width:100%;height:22.5vw;background-size:cover;background-position:50%;background-repeat:no-repeat}.mainlayout[_ngcontent-%COMP%]   .scroller[_ngcontent-%COMP%]   .pics[_ngcontent-%COMP%]   .image[_ngcontent-%COMP%]:before{content:"";display:block;height:0;width:0;padding-bottom:133.33333%}.sortable-drag[_ngcontent-%COMP%]{display:none}ion-fab-button[_ngcontent-%COMP%]{--color:var(--ion-background-color)}']}),v);function w(e,t){if(1&e){var n=h.Ob();h.Nb(0,"ion-button",3),h.Vb("click",(function(){h.hc(n);var e=t.$implicit;return h.Xb().accept(e)})),h.pc(1),h.Mb()}if(2&e){var i=t.$implicit;h.zb(1),h.qc(i)}}var x,C=((x=function(){function e(t){_classCallCheck(this,e),this.popCtrl=t}return _createClass(e,[{key:"accept",value:function(e){this.popCtrl.dismiss(e)}}]),e}()).\u0275fac=function(e){return new(e||x)(h.Kb(i.z))},x.\u0275cmp=h.Eb({type:x,selectors:[["app-confirm"]],inputs:{options:"options",text:"text"},decls:4,vars:2,consts:[[1,"popcontainer"],[1,"text"],[3,"click",4,"ngFor","ngForOf"],[3,"click"]],template:function(e,t){1&e&&(h.Nb(0,"div",0),h.Nb(1,"div",1),h.pc(2),h.Mb(),h.nc(3,w,2,1,"ion-button",2),h.Mb()),2&e&&(h.zb(2),h.rc(" ",t.text," "),h.zb(1),h.cc("ngForOf",t.options))},directives:[s.j,i.c],styles:["div.popcontainer[_ngcontent-%COMP%]{padding:10px;display:flex;flex-direction:column}div.popcontainer[_ngcontent-%COMP%]   div.text[_ngcontent-%COMP%]{padding:5px;text-align:center;font-size:20px}"],changeDetection:0}),x),k={prefix:"fas",iconName:"check",icon:[512,512,[],"f00c","M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"]},P={prefix:"fas",iconName:"microphone",icon:[352,512,[],"f130","M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"]},M={prefix:"fas",iconName:"pause",icon:[448,512,[],"f04c","M144 479H48c-26.5 0-48-21.5-48-48V79c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v352c0 26.5-21.5 48-48 48zm304-48V79c0-26.5-21.5-48-48-48h-96c-26.5 0-48 21.5-48 48v352c0 26.5 21.5 48 48 48h96c26.5 0 48-21.5 48-48z"]},O={prefix:"fas",iconName:"play",icon:[448,512,[],"f04b","M424.4 214.7L72.4 6.6C43.8-10.3 0 6.1 0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1 0-82.6z"]},R={prefix:"fas",iconName:"square",icon:[448,512,[],"f0c8","M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48z"]},_=n("pooC"),D=["frames"],T=["images"],E=["overlays"];function A(e,t){1&e&&h.Lb(0,"ion-spinner")}function I(e,t){if(1&e&&(h.Nb(0,"div",15,16),h.Lb(2,"img",17,18),h.Lb(4,"canvas",19,20),h.Mb()),2&e){var n=t.$implicit,i=t.index,s=h.Xb();h.zb(2),h.cc("src",n.src,h.jc),h.zb(2),h.cc("width",n.width)("height",n.height)("ngStyle",s.cstyle[i])}}function S(e,t){1&e&&h.Lb(0,"ion-icon",21)}var L=function(e,t){return{selected:e,marked:t}};function z(e,t){if(1&e&&(h.Nb(0,"div"),h.Lb(1,"div",22),h.Mb()),2&e){var n=t.$implicit,i=h.Xb();h.zb(1),h.cc("ngClass",h.dc(1,L,n===i.current,n<=i.highwater))}}function N(e,t){1&e&&h.Lb(0,"ion-icon",23)}var j,F,B=((j=function(){function e(t,n,i,s){_classCallCheck(this,e),this.sesh=t,this.detol=n,this.tools=i,this.change=s,this.selected=0,this.enabled=!1,this.reverse=!1,this.highwater=0,this.move=new h.n,this.current=0,this.loading=!0,this.imageList=[],this.thumbs={prev:"",cur:"",next:""},this.progress=[],this.started=new _.Deferred,this.cstyle=[]}return _createClass(e,[{key:"ngOnInit",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n,i,s=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=_createForOfIteratorHelper(this.images),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=13;break}return i=n.value,e.t0=this.imageList,e.next=8,this.sesh.getLocalImageFromId(i);case 8:e.t1=e.sent,e.t0.push.call(e.t0,e.t1),console.log(i);case 11:e.next=3;break;case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(1),t.e(e.t2);case 18:return e.prev=18,t.f(),e.finish(18);case 21:this.setThumbs(),this.progress=Array.from({length:this.imageList.length},(function(e,t){return t})),this.orientListener=function(){s.homeIndex(s.current)},window.addEventListener("resize",this.orientListener),this.change.markForCheck(),setTimeout((function(){s.loading=!1,s.resizeCanvas(),s.change.markForCheck(),s.started.resolve()}),100);case 22:case"end":return e.stop()}}),e,this,[[1,15,18,21]])})))}},{key:"waitForStart",value:function(){return this.started.promise}},{key:"ngOnDestroy",value:function(){window.removeEventListener("resize",this.orientListener)}},{key:"seekTo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"auto";this.current=e,this._moveTo(this.current,t)}},{key:"getCurrent",value:function(){return this.current}},{key:"setThumbs",value:function(){this.thumbs={prev:this.current>0?this.imageList[this.current-1].style:"",cur:this.imageList[this.current].style,next:this.current<this.imageList.length-1?this.imageList[this.current+1].style:""}}},{key:"clickThumb",value:function(e){if(this.enabled&&(this.reverse||-1!==e)){var t=this.current+e;t<0||t>=this.imageList.length||(this.current=t,this.move.emit(t),this._moveTo(t,"smooth"))}}},{key:"_moveTo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"auto";this.homeIndex(e,t),this.setThumbs()}},{key:"homeIndex",value:function(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1],Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("scrolling"),t.next=3,this.tools.smoothScroll(this.frameElements.toArray()[e].nativeElement);case 3:console.log("done"),this.resizeCanvas();case 5:case"end":return t.stop()}}),t,this)})))}},{key:"resizeCanvas",value:function(){this.cstyle=this.imageElements.map((function(e){return{width:e.nativeElement.width.toString()+"px",height:e.nativeElement.height.toString()+"px"}})),console.log("cstyle",this.cstyle)}},{key:"getCanvas",value:function(e){try{return{canvas:this.canvasElements.toArray()[e].nativeElement,width:this.imageList[e].width,height:this.imageList[e].height}}catch(t){console.log("canvas elements",this.canvasElements.toArray())}}}]),e}()).\u0275fac=function(e){return new(e||j)(h.Kb(c.a),h.Kb(u.b),h.Kb(l.a),h.Kb(h.h))},j.\u0275cmp=h.Eb({type:j,selectors:[["app-swiper"]],viewQuery:function(e,t){var n;1&e&&(h.sc(D,!0),h.sc(T,!0),h.sc(E,!0)),2&e&&(h.fc(n=h.Wb())&&(t.frameElements=n),h.fc(n=h.Wb())&&(t.imageElements=n),h.fc(n=h.Wb())&&(t.canvasElements=n))},inputs:{images:"images",selected:"selected",enabled:"enabled",reverse:"reverse",highwater:"highwater"},outputs:{move:"move"},decls:16,vars:9,consts:[[4,"ngIf"],[1,"layout"],[1,"mainwrapper"],[1,"mainscroller"],["scroller",""],["class","frame",4,"ngFor","ngForOf"],[1,"thumbwrapper"],[1,"thumbslot","imageslot","left",3,"click"],[1,"image"],["name","arrow-back","class","arrow back",4,"ngIf"],[1,"thumbslot","progressslot"],[1,"progress"],[4,"ngFor","ngForOf"],[1,"thumbslot","imageslot","right",3,"click"],["name","arrow-forward","class","arrow forward",4,"ngIf"],[1,"frame"],["frames",""],[3,"src"],["images",""],[3,"width","height","ngStyle"],["overlays",""],["name","arrow-back",1,"arrow","back"],[1,"bullet",3,"ngClass"],["name","arrow-forward",1,"arrow","forward"]],template:function(e,t){1&e&&(h.nc(0,A,1,0,"ion-spinner",0),h.Nb(1,"div",1),h.Nb(2,"div",2),h.Nb(3,"div",3,4),h.nc(5,I,6,4,"div",5),h.Mb(),h.Nb(6,"div",6),h.Nb(7,"div",7),h.Vb("click",(function(){return t.clickThumb(-1)})),h.Lb(8,"div",8),h.nc(9,S,1,0,"ion-icon",9),h.Mb(),h.Nb(10,"div",10),h.Nb(11,"div",11),h.nc(12,z,2,4,"div",12),h.Mb(),h.Mb(),h.Nb(13,"div",13),h.Vb("click",(function(){return t.clickThumb(1)})),h.Lb(14,"div",8),h.nc(15,N,1,0,"ion-icon",14),h.Mb(),h.Mb(),h.Mb(),h.Mb()),2&e&&(h.cc("ngIf",t.loading),h.zb(5),h.cc("ngForOf",t.imageList),h.zb(3),h.mc("background-image",t.thumbs.prev,h.Db),h.zb(1),h.cc("ngIf",t.reverse&&0!==t.current),h.zb(3),h.cc("ngForOf",t.progress),h.zb(2),h.mc("background-image",t.thumbs.next,h.Db),h.zb(1),h.cc("ngIf",t.current!==t.imageList.length-1))},directives:[s.k,s.j,i.p,s.l,i.k,s.i],styles:["ion-spinner[_ngcontent-%COMP%]{width:100px;height:100px;margin-left:auto;margin-right:auto}.layout[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column;align-items:center;position:relative}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]{width:60vw;height:45vw}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]{overflow-x:hidden;overflow-y:hidden;white-space:nowrap;width:60vw;height:45vw;position:relative;pointer-events:none}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]   .frame[_ngcontent-%COMP%]{width:60vw;height:45vw;max-height:45vw;display:inline-block;position:relative;margin-right:5px}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]   .frame[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{position:absolute;left:0;top:0;bottom:0;right:0;-o-object-fit:contain;object-fit:contain;max-height:100%;max-width:100%;margin:auto;display:block;-webkit-filter:drop-shadow(1px 1px 2px var(--ion-color-dark));filter:drop-shadow(1px 1px 2px var(--ion-color-dark))}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{position:absolute;pointer-events:auto;top:0;left:0;bottom:0;right:0;z-index:5;margin:auto;display:block;touch-action:none}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]{position:absolute;width:100%;top:25%;left:0;display:flex;flex-direction:row;justify-content:space-between;padding-left:5px;padding-right:5px;overflow:hidden}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot[_ngcontent-%COMP%]{height:100%;display:flex;flex-direction:column}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot.imageslot[_ngcontent-%COMP%]{display:flex}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot.imageslot.left[_ngcontent-%COMP%]{align-items:flex-start}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot.imageslot.right[_ngcontent-%COMP%]{align-items:flex-end}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot.progressslot[_ngcontent-%COMP%]{display:flex;align-items:flex-start}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .image[_ngcontent-%COMP%]{width:17vw;height:17vw;background-size:cover;-webkit-filter:drop-shadow(1px 1px 2px var(--ion-color-dark));filter:drop-shadow(1px 1px 2px var(--ion-color-dark))}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]{width:60vw;height:30px;display:flex;flex-direction:row;flex-wrap:wrap;justify-content:center;color:var(--ion-color-primary);height:12px}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]   .bullet[_ngcontent-%COMP%]{width:8px;height:8px;border-radius:50%;border:1px solid var(--ion-color-primary-deselect);margin:2px 1.5px}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]   .bullet.selected[_ngcontent-%COMP%]{background:var(--ion-color-primary-deselect)}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]   .bullet.marked[_ngcontent-%COMP%]{border:1px solid var(--ion-color-primary)}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]   .bullet.selected.marked[_ngcontent-%COMP%]{background:var(--ion-color-primary)}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   ion-icon.arrow[_ngcontent-%COMP%]{font-size:35px;color:var(--ion-color-primary);bottom:18vh}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   ion-icon.arrow.back[_ngcontent-%COMP%]{left:5px}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   ion-icon.arrow.forward[_ngcontent-%COMP%]{right:5px}.image[_ngcontent-%COMP%]{background-position:50%;background-repeat:no-repeat}@media (orientation:portrait){.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%], .layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]{width:100vw;height:75vw}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]   .frame[_ngcontent-%COMP%]{width:100vw;height:75vw;max-height:75vw}.layout[_ngcontent-%COMP%]   .mainwrapper[_ngcontent-%COMP%]   .mainscroller[_ngcontent-%COMP%]   .frame[_ngcontent-%COMP%]   .image[_ngcontent-%COMP%]{width:100%;height:100%}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]{position:absolute;width:100%;top:calc(75vw + 10px)}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot.imageslot[_ngcontent-%COMP%]{display:flex}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .thumbslot.imageslot[_ngcontent-%COMP%]   .image[_ngcontent-%COMP%]{width:30vw;height:30vw}.layout[_ngcontent-%COMP%]   .thumbwrapper[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]{width:30vw}}"]}),j),Y=n("XNiG"),V=function(e){return e[e.STOPPED=0]="STOPPED",e[e.STARTING=1]="STARTING",e[e.RECORDING=2]="RECORDING",e[e.STOPPING=3]="STOPPING",e}({}),G=function(){function e(t){_classCallCheck(this,e),this.connected=!1,this.progressSubject=new Y.a,this.config={bufferLen:4096,numChannels:1},this.recordingState=V.STOPPED,this.stopTick=0,this.startRecording=null,this.recordedData=[],this.pinterval=null,this.volume=-50,this.audioContext=t&&t.audioContext?t.audioContext:new AudioContext,this.debugMode=!(!t||!t.debug)&&t.debug,t&&t.bufferLen&&(this.config.bufferLen=t.bufferLen),this._init()}return _createClass(e,[{key:"_init",value:function(){this.debug("init()")}},{key:"debug",value:function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.debugMode&&(e=console).log.apply(e,["simpleMicrophone:"].concat(n))}},{key:"connect",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){e.next=2;break}throw new Error("No mediaDevices.getUserMedia in browser!");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({audio:!0,video:!1});case 4:t=e.sent,this.sourceNode=this.audioContext.createMediaStreamSource(t),this.stream=t,this.node=this.audioContext.createScriptProcessor(this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=function(e){var t=e.inputBuffer.getChannelData(0);if(n._setVolumeFromBuffer(t),n.recordingState!==V.STOPPED){if(n.recordingState===V.STARTING){for(var i=0;i<2e3;++i)t[i]=i/2e3*t[i];n.debug("recording - set recording state"),n.recordingState=V.RECORDING}else if(n.recordingState===V.STOPPING)if(1===n.stopTick){n.debug("set recording stopped state"),n.recordingState=V.STOPPED;for(var s=0;s<2e3;++s)t[-s]=s/2e3*t[-s]}else++n.stopTick;n.recordedData.push(t.slice(0))}},this.sourceNode.connect(this.node),this.node.connect(this.audioContext.destination),this.connected=!0,this._progressTick();case 6:case"end":return e.stop()}}),e,this)})))}},{key:"_setVolumeFromBuffer",value:function(e){for(var t,n=0,i=0;i<e.length;i++)n+=(t=e[i])*t;var s=Math.sqrt(n/e.length),r=Math.max(s,.95*this.volume);this.volume=10*Math.log(r)}},{key:"record",value:function(){if(!this.sourceNode)throw new Error("No source node, did you call .connect() first?");if(!this.canRecord())throw new Error("Cannot start recording, check canRecord() first.");this.debug("recording - set start state"),this.startRecording=new Date,this.recordingState=V.STARTING}},{key:"destroy",value:function(){if(this.stream){var e,t=_createForOfIteratorHelper(this.stream.getAudioTracks());try{for(t.s();!(e=t.n()).done;){e.value.stop()}}catch(n){t.e(n)}finally{t.f()}}this.connected=!1,this.progressSubject.complete()}},{key:"getElapsed",value:function(){return this.getLength().ms}},{key:"isRecording",value:function(){return this.recordingState!==V.STOPPED}},{key:"hasRecordedData",value:function(){return 0!==this.recordedData.length}},{key:"observeProgress",value:function(){return this.progressSubject.asObservable()}},{key:"pause",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isRecording()){e.next=7;break}this.debug("recording set stopping state"),this.recordingState=2,this.debug("pausing");case 2:if(!this.isRecording()){e.next=7;break}return e.next=5,this._waitMilliseconds(100);case 5:e.next=2;break;case 7:case"end":return e.stop()}}),e,this)})))}},{key:"canRecord",value:function(){return this.connected&&this.recordingState==V.STOPPED}},{key:"resume",value:function(){return!this.isRecording()&&(this.recordingState=V.STARTING,!0)}},{key:"stop",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.debug("recording set stopping state"),this.recordingState=V.STOPPING;case 1:if(!this.isRecording()){e.next=6;break}return e.next=4,this._waitMilliseconds(100);case 4:e.next=1;break;case 6:return e.abrupt("return",this.getLength());case 7:case"end":return e.stop()}}),e,this)})))}},{key:"getLength",value:function(){var e,t=0,n=_createForOfIteratorHelper(this.recordedData);try{for(n.s();!(e=n.n()).done;){t+=e.value.length}}catch(i){n.e(i)}finally{n.f()}return{ms:Math.floor(t/this.audioContext.sampleRate*1e3),frames:t}}},{key:"_waitMilliseconds",value:function(e){return new Promise((function(t){setTimeout((function(){t()}),e)}))}},{key:"getBuffer",value:function(){return this._getMergedBuffers(this.recordedData)}},{key:"clear",value:function(){this.recordingState=V.STOPPED,this.recordedData=[],console.log("simple microphone cleared",this.recordedData)}},{key:"_progressTick",value:function(){var e=this;this.pinterval||(this.pinterval=setInterval((function(){e.progressSubject.next({elapsed:e.getElapsed(),db:e.volume})}),100))}},{key:"_getMergedBuffers",value:function(e){var t,n=0,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){n+=t.value.length}}catch(a){i.e(a)}finally{i.f()}for(var s=new Float32Array(n),r=0,o=0;o<e.length;o++)s.set(e[o],r),r+=e[o].length;return s}}]),e}(),H=function(){function e(t){_classCallCheck(this,e),this.config={audioContext:new AudioContext,sampleRate:16e3,channels:1},this.buffer=null,this.playing=!1,this.replaying=!1,this.progressSubject=new Y.a,t&&Object.assign(this.config,t)}return _createClass(e,[{key:"loadFile",value:function(e){var t=this;return this.config.sampleRate=e.sampleRate,new Promise((function(n){var i=new FileReader;i.onloadend=function(){new OfflineAudioContext(1,1,t.config.sampleRate).decodeAudioData(i.result).then((function(i){var s=new Float32Array(e.frames);i.copyFromChannel(s,0),t.buffer=s,n()}))},i.readAsArrayBuffer(e.file)}))}},{key:"addResample",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._resampleBuffer(e);case 2:return n=t.sent,i=this.buffer?this.buffer.length:0,t.abrupt("return",(this.buffer=this.buffer?this._mergeBuffers([this.buffer,n]):n,{offset:i,frames:n.length}));case 5:case"end":return t.stop()}}),t,this)})))}},{key:"getLength",value:function(){return{frames:null!==this.buffer?this.buffer.length:0,ms:null!==this.buffer?~~(this.buffer.length/this.config.sampleRate*1e3):0}}},{key:"_resampleBuffer",value:function(e){var t=new OfflineAudioContext(1,~~(e.length/this.config.audioContext.sampleRate*this.config.sampleRate),this.config.sampleRate),n=t.createBuffer(1,e.length,this.config.audioContext.sampleRate);n.copyToChannel(e,0);var i=t.createBufferSource();return i.buffer=n,i.connect(t.destination),i.start(),t.startRendering().then((function(e){return new Float32Array(e.getChannelData(0))}))}},{key:"deleteFrom",value:function(e){this.buffer=0===e?null:this.buffer.slice(0,e)}},{key:"exportWav",value:function(){var e,t,n,i,s=this,r=function(e,t,n){for(var i=0;i<n.length;i++)e.setUint8(t+i,n.charCodeAt(i))};return new Blob([(e=this.config.sampleRate,t=s.buffer.length,n=new ArrayBuffer(44+2*t),i=new DataView(n),r(i,0,"RIFF"),i.setUint32(4,36+2*t,!0),r(i,8,"WAVE"),r(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,1,!0),i.setUint32(24,e,!0),i.setUint32(28,4*e,!0),i.setUint16(32,2,!0),i.setUint16(34,16,!0),r(i,36,"data"),i.setUint32(40,2*t,!0),function(e,t,n){for(var i=0;i<n.length;i++,t+=2){var s=Math.max(-1,Math.min(1,n[i]));e.setInt16(t,s<0?32768*s:32767*s,!0)}}(i,44,s.buffer),i)],{type:"audio/wav"})}},{key:"clear",value:function(){this.buffer=null}},{key:"_mergeBuffers",value:function(e){var t,n=0,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){n+=t.value.length}}catch(a){i.e(a)}finally{i.f()}for(var s=new Float32Array(n),r=0,o=0;o<e.length;o++)s.set(e[o],r),r+=e[o].length;return s}},{key:"playFromMs",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.playstartfromms=e;var t=Math.round(e/1e3*16e3);this.playFromFrame(t)}},{key:"playFromFrame",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(null===this.buffer)throw new Error("No audio data in buffer");if(t>=this.buffer.length)throw new Error("listen From frame is larger than buffer");this.playing?(this.playsource.stop(),this.replaying=!0):this.replaying=!1;var n=this.config.audioContext.createBuffer(1,this.buffer.length-t,this.config.sampleRate),i=this.buffer.slice(t);n.getChannelData(0).set(i);var s=this.config.audioContext.createBufferSource();s.buffer=n,s.connect(this.config.audioContext.destination),s.start(),this.playing=!0,this.playsource=s,this.playstarttime=new Date,s.onended=function(){e.replaying?e.replaying=!1:(e.progressSubject.next(-1),e.playing=!1)},this.progressLoop()}},{key:"stopPlay",value:function(){this.playing&&(this.replaying=!1,this.playsource.stop(),this.playing=!1)}},{key:"progressLoop",value:function(){var e=this;if(this.playing){var t=(new Date).valueOf()-this.playstarttime.valueOf();this.progressSubject.next(this.playstartfromms+t),this.playing&&setTimeout((function(){e.progressLoop()}),100)}}},{key:"getPlayProgress",value:function(){return this.progressSubject.asObservable()}},{key:"hasData",value:function(){return null!==this.buffer}},{key:"destroy",value:function(){this.stopPlay(),this.progressSubject.complete()}}]),e}(),Q=n("EnSQ"),W=((F=function(){function e(t){_classCallCheck(this,e),this.tools=t,this.audioCtx=new AudioContext,this.players=new Map}return _createClass(e,[{key:"resumeAudioContext",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0="running"!==this.audioCtx.state,!e.t0){e.next=4;break}return e.next=4,this.audioCtx.resume();case 4:case"end":return e.stop()}}),e,this)})))}},{key:"getAudioContext",value:function(){return this.audioCtx}},{key:"errorbeep",value:function(){new Audio("data:audio/wav;base64,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").play()}},{key:"confbeep",value:function(){new Audio("data:audio/wav;base64,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").play()}},{key:"getWavMetadata",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){var n=new FileReader;n.onloadend=function(){var e=new DataView(n.result),i=e.getUint16(22,!0),s=e.getUint32(24,!0),r=e.getUint32(40,!0),o=e.getUint16(32,!0);t({channelCount:i,sampleRate:s,samples:r/o,duration:r/o/s})},n.readAsArrayBuffer(e)})));case 1:case"end":return t.stop()}}),t)})))}},{key:"getAudioMetadata",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){var i=new FileReader;i.onloadend=function(){n.audioCtx.decodeAudioData(i.result).then((function(e){t({channels:e.numberOfChannels,sampleRate:e.sampleRate,samples:e.length,duration:e.length/e.sampleRate})}))},i.readAsArrayBuffer(e)})));case 1:case"end":return t.stop()}}),t)})))}},{key:"resampleBuffer",value:function(e,t,n){var i=new OfflineAudioContext(1,~~(e.length/t.sampleRate*n),n),s=i.createBuffer(1,e.length,t.sampleRate);s.copyToChannel(e,0);var r=i.createBufferSource();return r.buffer=s,r.connect(i.destination),r.start(),i.startRendering().then((function(e){return new Float32Array(e.getChannelData(0))}))}},{key:"float32ArrayToWav",value:function(e,t,n){var i,s,r,o=function(e,t,n){for(var i=0;i<n.length;i++)e.setUint8(t+i,n.charCodeAt(i))};return new Blob([(i=e.length,s=new ArrayBuffer(44+2*i),r=new DataView(s),o(r,0,"RIFF"),r.setUint32(4,36+2*i,!0),o(r,8,"WAVE"),o(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,n,!0),r.setUint32(28,4*n,!0),r.setUint16(32,2*t,!0),r.setUint16(34,16,!0),o(r,36,"data"),r.setUint32(40,2*i,!0),function(e,t,n){for(var i=0;i<n.length;i++,t+=2){var s=Math.max(-1,Math.min(1,n[i]));e.setInt16(t,s<0?32768*s:32767*s,!0)}}(r,44,e),r)],{type:"audio/wav"})}}]),e}()).\u0275fac=function(e){return new(e||F)(h.Rb(l.a))},F.\u0275prov=h.Gb({token:F,factory:F.\u0275fac,providedIn:"root"}),F),U=n("6NWb");function Z(e,t){if(1&e){var n=h.Ob();h.Nb(0,"ion-fab",8),h.Vb("click",(function(){return h.hc(n),h.Xb().finish()})),h.Nb(1,"ion-fab-button"),h.Lb(2,"ion-icon",9),h.Mb(),h.Mb()}}var J,K=function(e,t,n){return{playing:e,disabled:t,"ion-activatable":n}},X=function(e,t,n){return{recording:e,disabled:t,"ion-activatable":n}},q=function(e){return e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.RECORDING=3]="RECORDING",e[e.RECBUSY=4]="RECBUSY",e[e.REVIEWING=5]="REVIEWING",e}({}),$=((J=function(){function e(t,n,i,s,r,o){_classCallCheck(this,e),this.modalCtrl=t,this.data=n,this.audio=i,this.popCtrl=s,this.tools=r,this.seshservice=o,this.faSquare=R,this.faPause=M,this.faPlay=O,this.elapsed=0,this.currentIndex=0,this.recordedMark=-1,this.startupPromises=[],this.state=q.LOADING,this.timeLine=[],this.startLength=0}return _createClass(e,[{key:"ngOnInit",value:function(){console.log(this.session),this.changeState(q.LOADING),this.session.igvTimeline&&(this.recordedMark=this.session.igvTimeline.length-1,this.timeLine=this.session.igvTimeline),this.startupPromises.push(this.initialise())}},{key:"ngAfterViewInit",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.startupPromises.push(this.swiper.waitForStart()),e.next=3,Promise.all(this.startupPromises);case 3:console.log("everything ready"),this.changeState(q.READY);case 5:case"end":return e.stop()}}),e,this)})))}},{key:"ngOnDestroy",value:function(){this.playSub&&this.playSub.unsubscribe()}},{key:"initialise",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.audioContext=this.audio.getAudioContext(),this.audioDataModel=new H({audioContext:this.audioContext,sampleRate:16e3,channels:1}),this.playSub=this.audioDataModel.getPlayProgress().subscribe((function(e){n.state===q.REVIEWING&&-1===e?n.changeState(q.READY):n.checkSlidePlayback(e)})),!this.session.primary){e.next=6;break}return e.next=3,this.data.getAudioFile(this.session.primary);case 3:return t=e.sent,e.next=6,this.audioDataModel.loadFile(t);case 6:return this.startLength=this.audioDataModel.getLength().frames,this.microphone=new G({audioContext:this.audioContext}),e.next=10,this.microphone.connect();case 10:case"end":return e.stop()}}),e,this)})))}},{key:"close",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.hasChanged()){t.next=6;break}return t.next=3,this.confirm("Quit and discard changes?",["Yep","Nah"],e);case 3:if((n=t.sent)&&"Nah"!==n){t.next=6;break}return t.abrupt("return");case 6:this.modalCtrl.dismiss();case 7:case"end":return t.stop()}}),t,this)})))}},{key:"clickRecord",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.flags.canPressRecord){e.next=15;break}if(this.state!==q.RECORDING){e.next=14;break}return console.log("stopping"),this.changeState(q.RECBUSY),e.next=5,this.microphone.stop();case 5:return t=e.sent,console.log("stopped"),e.next=9,this.audioDataModel.addResample(this.microphone.getBuffer());case 9:this.microphone.clear(),this.getLastSegment().endMs=this.audioDataModel.getLength().ms+t.ms,this.changeState(q.READY),e.next=15;break;case 14:console.log("recording"),this.changeState(q.RECORDING),this.microphone.record(),this.startResumeSegment();case 15:case"end":return e.stop()}}),e,this)})))}},{key:"clickPlay",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.flags.canReview&&(this.state===q.REVIEWING?this.audioDataModel.stopPlay():(this.changeState(q.REVIEWING),this.currentIndex=0,this.swiper.seekTo(this.currentIndex),this.audioDataModel.playFromMs(0),console.log(this.timeLine)));case 1:case"end":return e.stop()}}),e,this)})))}},{key:"swiperMove",value:function(e){console.log("slide",e),this.currentIndex=e,this.state===q.RECORDING?(this.transitionSlide(),e>this.recordedMark&&(this.recordedMark=e)):this.state===q.REVIEWING&&(this.currentIndex<this.timeLine.length-1?this.audioDataModel.playFromMs(this.timeLine[this.currentIndex].startMs):this.changeState(q.READY))}},{key:"changeState",value:function(e){e===q.LOADING?this.flags={isRecording:!1,isReviewing:!1,canSlide:!1,canReverse:!1,canPressRecord:!1,canReview:!1,canFinish:!1}:e===q.READY?this.flags={isRecording:!1,isReviewing:!1,canSlide:!0,canReverse:!0,canPressRecord:!0,canReview:this.audioDataModel.hasData(),canFinish:this.hasChanged()}:e===q.RECORDING?(this.flags={isRecording:!0,isReviewing:!1,canSlide:!0,canReverse:!1,canPressRecord:!0,canReview:!1,canFinish:!1},this.currentIndex!==this.recordedMark&&(-1===this.recordedMark?(this.currentIndex=0,this.recordedMark=0):this.currentIndex=this.recordedMark,this.swiper.seekTo(this.currentIndex))):e===q.RECBUSY?this.flags={isRecording:!0,isReviewing:!1,canSlide:!1,canReverse:!1,canPressRecord:!1,canReview:!1,canFinish:!1}:e===q.REVIEWING&&(this.flags={isRecording:!1,isReviewing:!0,canSlide:!0,canReverse:!0,canPressRecord:!1,canReview:!0,canFinish:this.hasChanged()}),this.state=e}},{key:"hasChanged",value:function(){return this.startLength!==this.audioDataModel.getLength().frames}},{key:"getLastSegment",value:function(){return this.timeLine[this.timeLine.length-1]}},{key:"startResumeSegment",value:function(){0===this.timeLine.length&&this.timeLine.push({startMs:0,promptId:this.session.imageIds[0]})}},{key:"transitionSlide",value:function(){var e=this.audioDataModel.getLength().ms+this.microphone.getElapsed();this.getLastSegment().endMs=e-1,this.timeLine.push({startMs:e,promptId:this.session.imageIds[this.currentIndex]})}},{key:"checkSlidePlayback",value:function(e){var t=this.timeLine.findIndex((function(t){return e>=t.startMs&&e<=t.endMs}));-1!==t&&t!==this.currentIndex&&(this.currentIndex=t,this.swiper.seekTo(this.currentIndex,"smooth"))}},{key:"finish",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.timeLine.length===this.session.imageIds.length&&++this.session.stage,t={blob:this.audioDataModel.exportWav(),language:"",frames:this.audioDataModel.getLength().frames,channels:this.audioDataModel.config.channels,sampleRate:this.audioDataModel.config.sampleRate},this.seshservice.updateSessionPrimaryAudio(this.session.id,{stage:this.session.stage,igvTimeline:this.timeLine},t),this.modalCtrl.dismiss();case 3:case"end":return e.stop()}}),e,this)})))}},{key:"confirm",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2],Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function n(){var i;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.popCtrl.create({component:C,componentProps:{text:e,options:t}});case 2:return i=n.sent,n.next=5,this.tools.showPopover(i);case 5:return n.abrupt("return",n.sent);case 6:case"end":return n.stop()}}),n,this)})))}}]),e}()).\u0275fac=function(e){return new(e||J)(h.Kb(i.x),h.Kb(Q.a),h.Kb(W),h.Kb(i.z),h.Kb(l.a),h.Kb(c.a))},J.\u0275cmp=h.Eb({type:J,selectors:[["ng-component"]],viewQuery:function(e,t){var n;1&e&&h.sc(B,!0),2&e&&h.fc(n=h.Wb())&&(t.swiper=n.first)},inputs:{session:"session"},decls:10,vars:19,consts:[["slot","icon-only","name","close",1,"closebutton",3,"click"],[3,"images","enabled","reverse","selected","highwater","move"],[1,"bigbutton","play","ion-activatable",3,"ngClass","click"],["type","unbounded"],[3,"icon"],[1,"bigbutton","record","ion-activatable",3,"ngClass","click"],[3,"icon","spin"],["class","finishbutton","horizontal","center","vertical","bottom",3,"click",4,"ngIf"],["horizontal","center","vertical","bottom",1,"finishbutton",3,"click"],["name","checkmark"]],template:function(e,t){1&e&&(h.Nb(0,"ion-icon",0),h.Vb("click",(function(e){return t.close(e)})),h.Mb(),h.Nb(1,"app-swiper",1),h.Vb("move",(function(e){return t.swiperMove(e)})),h.Mb(),h.pc(2,"> "),h.Nb(3,"div",2),h.Vb("click",(function(){return t.clickPlay()})),h.Lb(4,"ion-ripple-effect",3),h.Lb(5,"fa-icon",4),h.Mb(),h.Nb(6,"div",5),h.Vb("click",(function(){return t.clickRecord()})),h.Lb(7,"ion-ripple-effect",3),h.Lb(8,"fa-icon",6),h.Mb(),h.nc(9,Z,3,0,"ion-fab",7)),2&e&&(h.zb(1),h.cc("images",t.session.imageIds)("enabled",t.flags.canSlide)("reverse",t.flags.canReverse)("selected",t.currentIndex)("highwater",t.recordedMark),h.zb(2),h.cc("ngClass",h.ec(11,K,t.flags.isReviewing,!t.flags.canReview,t.flags.canReview)),h.zb(2),h.cc("icon",t.flags.isReviewing?t.faPause:t.faPlay),h.zb(1),h.cc("ngClass",h.ec(15,X,t.flags.isRecording,!t.flags.canSlide,t.flags.canPressRecord)),h.zb(2),h.cc("icon",t.faSquare)("spin",t.flags.isRecording),h.zb(1),h.cc("ngIf",t.flags.canFinish))},directives:[i.k,B,s.i,i.m,U.a,s.k,i.h,i.i],styles:["div.bigbutton[_ngcontent-%COMP%]{width:100px;height:100px;position:absolute;bottom:5px;border-radius:50%;background-color:var(--ion-color-primary);display:flex;align-items:center;justify-content:center;box-shadow:0 3px 5px -1px rgba(0,0,0,.3)}div.bigbutton[_ngcontent-%COMP%]   fa-icon[_ngcontent-%COMP%]{color:var(--ion-color-primary-contrast);font-size:24px}.bigbutton.record[_ngcontent-%COMP%]{right:5px}.bigbutton.record.recording[_ngcontent-%COMP%]{background-color:red}.bigbutton.play[_ngcontent-%COMP%]{left:5px}.bigbutton.play.playing[_ngcontent-%COMP%]{background-color:green}.bigbutton.disabled[_ngcontent-%COMP%]{background-color:var(--ion-color-primary-deselect);opacity:.5}.finishbutton[_ngcontent-%COMP%]{bottom:5px}@media (orientation:portrait){app-swiper[_ngcontent-%COMP%]{margin-top:35px}}"]}),J),ee=n("FAoz"),te=n.n(ee),ne=function(e){return e[e.READY=0]="READY",e[e.TOUCHING=1]="TOUCHING",e[e.SELECTED=2]="SELECTED",e[e.DISABLED=3]="DISABLED",e}({}),ie=function(){function e(t,n){var i=this;_classCallCheck(this,e),this.canvii=[],this.active=0,this.touchEvtSub=new Y.a,this.state=ne.READY,this.animating=!1,this.animateToggle=0,n.forEach((function(e,n){var s=t.getCanvas(n);i.canvii.push({canvas:s.canvas,width:s.width,height:s.height,boxes:[]})}))}return _createClass(e,[{key:"activate",value:function(e){var t=this;this.af&&this.af.destroy(),this.box=null,this.drawupdate("foo");var n=this.canvii[e].canvas;this.active=e,this.setState(ne.READY),this.af=new te.a(n,{multipointStart:function(e){t.state!==ne.DISABLED&&(console.log("start",e),t.touchEvtSub.next(ne.TOUCHING),t.state=ne.TOUCHING)},pinch:function(e){t.state!==ne.DISABLED&&t.processpinch(e.targetTouches)},multipointEnd:function(e){t.state!==ne.DISABLED&&(console.log("ended",e),t.state===ne.TOUCHING&&(t.touchEvtSub.next(ne.SELECTED),t.state=ne.SELECTED))}})}},{key:"setState",value:function(e){this.state=e}},{key:"enable",value:function(){this.state=ne.READY}},{key:"disable",value:function(){this.state=ne.DISABLED}},{key:"observe",value:function(){return this.touchEvtSub.asObservable()}},{key:"processpinch",value:function(e){var t=e[0].clientX,n=e[0].clientY,i=e[1].clientX,s=e[1].clientY;(t>t||n>s)&&(i=[t,t=i][0],s=[n,n=s][0]);var r=this.canvii[this.active].canvas.getBoundingClientRect();t-=r.left,n-=r.top,i-=r.left,s-=r.top,this.box={x1:t,y1:n,x2:i,y2:s},this.drawupdate("red")}},{key:"getSelected",value:function(){return this.box}},{key:"getMidPointCS",value:function(){var e=this.canvii[this.active].canvas.getBoundingClientRect(),t=this.box.x1+e.left+(this.box.x2-this.box.x1)/2;return{top:(this.box.y1+e.top+(this.box.y2-this.box.y1)/2).toString()+"px",left:t.toString()+"px"}}},{key:"drawupdate",value:function(e){var t=this.canvii[this.active].canvas,n=t.width/t.clientWidth,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var s,r=function(e,t){var s=t.x2-t.x1,r=t.y2-t.y1;i.strokeStyle=e,i.lineWidth=Math.round(3*n),i.beginPath(),i.rect(t.x1*n,t.y1*n,s*n,r*n),i.stroke()},o=_createForOfIteratorHelper(this.canvii[this.active].boxes);try{for(o.s();!(s=o.n()).done;){r("grey",s.value)}}catch(a){o.e(a)}finally{o.f()}this.box&&r(e,this.box)}},{key:"savebox",value:function(){if(!this.box)throw new Error("no box to save");var e=Object.assign({},this.box);return this.canvii[this.active].boxes.push(e),this.box=null,this.drawupdate("red"),console.log(this.canvii),e}},{key:"popbox",value:function(){if(0===this.canvii[this.active].boxes.length)throw new Error("no box to pop");this.canvii[this.active].boxes.pop()}},{key:"getboxlength",value:function(){return this.canvii[this.active].boxes.length}},{key:"animate",value:function(e){this.animatecolor=e,this.animateToggle=0,this.animating=!0,this.doanimate()}},{key:"stopanimate",value:function(e){this.animating=!1,this.drawupdate(e)}},{key:"doanimate",value:function(){var e=this;this.animating&&(this.animateToggle?(this.drawupdate(this.animatecolor),this.animateToggle=0):(this.drawupdate("black"),this.animateToggle=1),setTimeout((function(){e.doanimate()}),400))}}]),e}(),se=function(){function e(t){_classCallCheck(this,e),this.updateRateMs=100,this.onProgressEvent=null,this.onEndEvent=null,this.playing=!1,this.ended=!1,this.currentTime=0,this.framesPlayed=0,this.progressSubject=new Y.a,this.debugMode=!1,this.pinterval=null,this.audioContext=t&&t.audioContext?t.audioContext:new AudioContext,this.debugMode=!(!t||!t.debug)&&t.debug}return _createClass(e,[{key:"debug",value:function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.debugMode&&(e=console).log.apply(e,["aikuplaya:"].concat(n))}},{key:"load",value:function(e){var t=this;return fetch(e,{mode:"cors"}).then((function(e){return e.arrayBuffer().then((function(e){return t._decodeAndInitialize(e)}))}))}},{key:"loadFromBlob",value:function(e){var t=this;return new Promise((function(n){var i=new FileReader;i.onloadend=function(){t._decodeAndInitialize(i.result).then((function(){n()}))},i.readAsArrayBuffer(e)}))}},{key:"_decodeAndInitialize",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.pause(),this.source=null,t.next=3,this.audioContext.decodeAudioData(e);case 3:n=t.sent,this.currentTime=0,this.buffer=n,this.sampleRate=n.sampleRate,this.frames=n.length,this.channels=n.numberOfChannels,this.duration=n.duration,this.scriptBufferLength=this._pow2floor(this.sampleRate*(this.updateRateMs/1e3)),this.updateInterval=this.scriptBufferLength/this.sampleRate;case 5:case"end":return t.stop()}}),t,this)})))}},{key:"_pow2floor",value:function(e){e++;for(var t=1;e>>=1;)t<<=1;return t}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function n(){var i=this;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise((function(n){i.currentTime=e,i.startOffset=i.currentTime,i.source=i.audioContext.createBufferSource(),i.source.buffer=i.buffer,i.source.connect(i.audioContext.destination),i.ended=!1,i.source.onended=function(){i.playing=!1,i.debug("ended"),i.ended=!0,i.progressSubject.next(-1),n()},i.source.start(0,i.currentTime,t),i.startPlay=new Date,i.playing=!0,i.startProgress()})));case 1:case"end":return n.stop()}}),n)})))}},{key:"playMs",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.play(e/1e3)}},{key:"startProgress",value:function(){var e=this;this.pinterval||(this.pinterval=setInterval((function(){if(!e.playing||e.ended)clearInterval(e.pinterval),e.pinterval=null;else{var t=((new Date).valueOf()-e.startPlay.valueOf())/1e3;e.currentTime=e.startOffset+t,e.progressSubject.next(e.currentTime)}}),100))}},{key:"pause",value:function(){this.playing&&(this.playing=!1,this.source.onended=null,this.source.stop())}},{key:"isPlaying",value:function(){return this.playing}},{key:"hasEnded",value:function(){return this.ended}},{key:"pos",value:function(){return this.currentTime}},{key:"setPos",value:function(e){this.currentTime=e}},{key:"observeProgress",value:function(){return this.progressSubject.asObservable()}},{key:"playBuffer",value:function(e,t){var n=this.audioContext.createBufferSource(),i=this.audioContext.createBuffer(1,e.length,t);i.getChannelData(0).set(e),n.buffer=i,n.connect(this.audioContext.destination),n.start()}},{key:"destroy",value:function(){this.pause(),this.progressSubject.complete()}}]),e}(),re=["floater"];function oe(e,t){if(1&e){var n=h.Ob();h.Nb(0,"ion-fab",8),h.Vb("click",(function(){return h.hc(n),h.Xb().finish()})),h.Nb(1,"ion-fab-button"),h.Lb(2,"ion-icon",9),h.Mb(),h.Mb()}}function ae(e,t){if(1&e){var n=h.Ob();h.Nb(0,"div",10),h.Vb("click",(function(){return h.hc(n),h.Xb().acceptLabelRecording()})),h.Lb(1,"fa-icon",7),h.Mb()}if(2&e){var i=h.Xb();h.zb(1),h.cc("icon",i.faCheck)}}var ce,le=function(e,t){return{recording:e,disabled:t}},he=function(e,t){return{playing:e,disabled:t}},ue=function(e){return e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.SELECTED=3]="SELECTED",e[e.RECORDING=4]="RECORDING",e[e.RECBUSY=5]="RECBUSY",e[e.REVIEWING=6]="REVIEWING",e[e.CONFIRMING=7]="CONFIRMING",e}({}),ge=function(e){return e[e.READY=0]="READY",e[e.TOUCHING=1]="TOUCHING",e[e.SELECTED=2]="SELECTED",e}({}),de=((ce=function(){function e(t,n,i,s,r,o){_classCallCheck(this,e),this.modalCtrl=t,this.popCtrl=n,this.tools=i,this.data=s,this.audio=r,this.change=o,this.faSquare=R,this.faPause=M,this.faPlay=O,this.faCheck=k,this.faMicrophone=P,this.timeLine=[],this.currentIndex=0,this.labelMark=-1,this.imageLabels={},this.recordedSegment=null}return _createClass(e,[{key:"ngOnInit",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("describe session",this.session),this.changeState(ue.LOADING),this.session.igvTimeline&&(this.timeLine=this.session.igvTimeline),this.session.imageLabels)for(this.imageLabels=Object.assign({},this.session.imageLabels),t=0;t<this.session.imageIds.length&&this.imageLabels.hasOwnProperty(this.session.imageIds[t]);++t)this.labelMark=t;return e.next=3,this.initialiseAudio();case 3:return e.next=5,this.swiper.waitForStart();case 5:this.cmt=new ie(this.swiper,this.session.imageIds),this.changeState(ue.READY),this.cmt.activate(0),this.cmt.observe().subscribe((function(e){e===ge.SELECTED?n.changeState(ue.SELECTED):e===ge.TOUCHING&&(n.state!==ue.SELECTED&&n.state!==ue.REVIEWING||n.changeState(ue.READY))}));case 9:case"end":return e.stop()}}),e,this)})))}},{key:"ngOnDestroy",value:function(){this.audioDataModel.destroy(),this.player.destroy()}},{key:"initialiseAudio",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.audioContext=this.audio.getAudioContext(),this.audioDataModel=new H({audioContext:this.audioContext,sampleRate:16e3,channels:1}),this.player=new se({audioContext:this.audioContext}),!this.session.primary){e.next=6;break}return e.next=3,this.data.getAudioFile(this.session.primary);case 3:return t=e.sent,e.next=6,this.player.loadFromBlob(t.file);case 6:return this.audioDataModel.getPlayProgress().subscribe((function(e){n.state===ue.REVIEWING&&-1===e&&n.changeState(ue.CONFIRMING)})),this.player.observeProgress().subscribe((function(e){console.log("progress",e),-1===e&&n.changeFlags({isPlaying:!1})})),this.microphone=new G({audioContext:this.audioContext}),e.next=11,this.microphone.connect();case 11:case"end":return e.stop()}}),e,this)})))}},{key:"getCurrentImageId",value:function(){return this.session.imageIds[this.currentIndex]}},{key:"close",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.hasChanged()){t.next=6;break}return t.next=3,this.confirm("Quit and discard changes?",["Yep","Nah"],e);case 3:if((n=t.sent)&&"Nah"!==n){t.next=6;break}return t.abrupt("return");case 6:this.modalCtrl.dismiss();case 7:case"end":return t.stop()}}),t,this)})))}},{key:"hasChanged",value:function(){return!1}},{key:"confirm",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2],Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function n(){var i;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.popCtrl.create({component:C,componentProps:{text:e,options:t}});case 2:return i=n.sent,n.next=5,this.tools.showPopover(i);case 5:return n.abrupt("return",n.sent);case 6:case"end":return n.stop()}}),n,this)})))}},{key:"swiperMove",value:function(e){console.log("slide",e),this.currentIndex=e,this.cmt.activate(e)}},{key:"changeState",value:function(e){e===ue.LOADING?this.flags={isRecording:!1,isReviewing:!1,isPlaying:!1,canPlay:!1,canSlide:!1,canAccept:!1,canReverse:!1,canPressRecord:!1,canFinish:!1}:e===ue.READY?(this.flags={isRecording:!1,isReviewing:!1,isPlaying:!1,canPlay:!0,canSlide:!0,canReverse:!1,canPressRecord:!1,canAccept:!1,canFinish:this.hasChanged()},this.cmt.enable()):e===ue.SELECTED?(this.flags={isRecording:!1,isReviewing:!1,isPlaying:!1,canPlay:!0,canSlide:!0,canReverse:!1,canAccept:!1,canPressRecord:!0,canFinish:this.hasChanged()},this.cmt.drawupdate("yellow"),this.cmt.enable()):e===ue.RECORDING?(this.flags={isRecording:!0,isReviewing:!1,isPlaying:!1,canPlay:!1,canSlide:!1,canReverse:!1,canAccept:!1,canPressRecord:!0,canFinish:this.hasChanged()},this.cmt.disable()):e===ue.RECBUSY?(this.flags={isRecording:!0,isReviewing:!1,isPlaying:!1,canPlay:!1,canSlide:!1,canReverse:!1,canAccept:!1,canPressRecord:!1,canFinish:this.hasChanged()},this.cmt.disable()):e===ue.REVIEWING?(this.flags={isRecording:!1,isReviewing:!0,isPlaying:!1,canPlay:!1,canSlide:!0,canReverse:!1,canAccept:!0,canPressRecord:!0,canFinish:this.hasChanged()},this.cmt.disable()):e===ue.CONFIRMING&&(this.flags={isRecording:!1,isReviewing:!1,isPlaying:!1,canPlay:!0,canSlide:!0,canReverse:!1,canAccept:!0,canPressRecord:!0,canFinish:this.hasChanged()}),this.state=e,this.change.markForCheck()}},{key:"finish",value:function(){}},{key:"recdown",value:function(e){e.preventDefault(),console.log("d down"),this.flags.canPressRecord&&!this.flags.isRecording&&(this.recordedSegment&&(this.audioDataModel.deleteFrom(this.recordedSegment.offset),this.recordedSegment=null),this.changeState(ue.RECORDING),this.microphone.record(),this.cmt.animate("red"))}},{key:"recup",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.preventDefault(),console.log("d up"),t.t0=this.state===ue.RECORDING,!t.t0){t.next=18;break}return console.log("stopping"),this.changeState(ue.RECBUSY),this.cmt.stopanimate("red"),t.next=9,this.microphone.stop();case 9:return console.log("stopped"),t.next=12,this.audioDataModel.addResample(this.microphone.getBuffer());case 12:this.recordedSegment=t.sent,this.microphone.clear(),this.changeState(ue.REVIEWING),console.log("reviewing"),this.audioDataModel.playFromFrame(this.recordedSegment.offset),this.cmt.drawupdate("green");case 18:case"end":return t.stop()}}),t,this)})))}},{key:"recmove",value:function(e){e.preventDefault()}},{key:"play",value:function(){if(this.flags.canPlay)if(this.flags.isPlaying)this.player.pause(),this.changeFlags({isPlaying:!1});else{var e=this.session.igvTimeline[this.currentIndex];this.player.play(e.startMs/1e3,e.endMs/1e3),this.changeFlags({isPlaying:!0})}}},{key:"acceptLabelRecording",value:function(){var e=this.cmt.savebox(),t=this.getCurrentImageId();t in this.imageLabels||(this.imageLabels[t]=[]),this.imageLabels[t].push({audio:{startFrame:this.recordedSegment.offset,endFrame:this.recordedSegment.offset+this.recordedSegment.frames-1},box:e}),console.log("labels",this.imageLabels),this.changeState(ue.READY)}},{key:"changeFlags",value:function(e){var t=Object.assign({},this.flags);Object.assign(t,e),this.flags=t,this.change.markForCheck()}}]),e}()).\u0275fac=function(e){return new(e||ce)(h.Kb(i.x),h.Kb(i.z),h.Kb(l.a),h.Kb(Q.a),h.Kb(W),h.Kb(h.h))},ce.\u0275cmp=h.Eb({type:ce,selectors:[["ng-component"]],viewQuery:function(e,t){var n;1&e&&(h.sc(B,!0),h.sc(re,!0)),2&e&&(h.fc(n=h.Wb())&&(t.swiper=n.first),h.fc(n=h.Wb())&&(t.floatingIcon=n.first))},inputs:{session:"session"},decls:8,vars:18,consts:[["slot","icon-only","name","close",1,"closebutton",3,"click"],[3,"images","enabled","reverse","selected","highwater","move"],["class","finishbutton","horizontal","center","vertical","bottom",3,"click",4,"ngIf"],["class","bigbutton accept ion-activatable",3,"click",4,"ngIf"],[1,"bigbutton","record","ion-activatable",3,"ngClass","touchstart","touchmove","touchend","touchcancel"],[3,"icon","spin"],[1,"bigbutton","play","ion-activatable",3,"ngClass","click"],[3,"icon"],["horizontal","center","vertical","bottom",1,"finishbutton",3,"click"],["name","checkmark"],[1,"bigbutton","accept","ion-activatable",3,"click"]],template:function(e,t){1&e&&(h.Nb(0,"ion-icon",0),h.Vb("click",(function(e){return t.close(e)})),h.Mb(),h.Nb(1,"app-swiper",1),h.Vb("move",(function(e){return t.swiperMove(e)})),h.Mb(),h.nc(2,oe,3,0,"ion-fab",2),h.nc(3,ae,2,1,"div",3),h.Nb(4,"div",4),h.Vb("touchstart",(function(e){return t.recdown(e)}))("touchmove",(function(e){return t.recmove(e)}))("touchend",(function(e){return t.recup(e)}))("touchcancel",(function(e){return t.recup(e)})),h.Lb(5,"fa-icon",5),h.Mb(),h.Nb(6,"div",6),h.Vb("click",(function(){return t.play()})),h.Lb(7,"fa-icon",7),h.Mb()),2&e&&(h.zb(1),h.cc("images",t.session.imageIds)("enabled",t.flags.canSlide)("reverse",t.flags.canReverse)("selected",t.currentIndex)("highwater",t.labelMark),h.zb(1),h.cc("ngIf",t.flags.canFinish),h.zb(1),h.cc("ngIf",t.flags.canAccept),h.zb(1),h.cc("ngClass",h.dc(12,le,t.flags.isRecording,!t.flags.canPressRecord)),h.zb(1),h.cc("icon",t.faSquare)("spin",t.flags.isRecording),h.zb(1),h.cc("ngClass",h.dc(15,he,t.flags.isPlaying,!t.flags.canPlay)),h.zb(1),h.cc("icon",t.flags.isPlaying?t.faPause:t.faPlay))},directives:[i.k,B,s.k,s.i,U.a,i.h,i.i],styles:["div.bigbutton[_ngcontent-%COMP%]{width:100px;height:100px;position:absolute;bottom:5px;border-radius:50%;background-color:var(--ion-color-primary);display:flex;align-items:center;justify-content:center;box-shadow:0 3px 5px -1px rgba(0,0,0,.3)}div.bigbutton[_ngcontent-%COMP%]   fa-icon[_ngcontent-%COMP%]{color:var(--ion-color-primary-contrast);font-size:28px}div.littlebutton[_ngcontent-%COMP%]{width:70px;height:70px;position:absolute;border-radius:50%;background-color:var(--ion-color-primary);display:flex;align-items:center;justify-content:center;box-shadow:0 3px 5px -1px rgba(0,0,0,.3)}div.littlebutton[_ngcontent-%COMP%]   fa-icon[_ngcontent-%COMP%]{color:var(--ion-color-primary-contrast);font-size:18px}.bigbutton.accept[_ngcontent-%COMP%]{bottom:120px;right:5px}.bigbutton.record[_ngcontent-%COMP%]{right:5px}.bigbutton.play[_ngcontent-%COMP%]{left:5px}.bigbutton.play.playing[_ngcontent-%COMP%]{background-color:green}.bigbutton.record.recording[_ngcontent-%COMP%]{background-color:red}.bigbutton.disabled[_ngcontent-%COMP%]{background-color:var(--ion-color-primary-deselect);opacity:.5}.finishbutton[_ngcontent-%COMP%]{bottom:5px}.labelbutton[_ngcontent-%COMP%]{position:absolute;border-radius:50%;background-color:var(--ion-color-primary);width:60px;height:60px;display:flex;align-items:center;justify-content:center;transform:translate(-50%,-50%);z-index:10;-webkit-filter:drop-shadow(0 0 5px var(--ion-color-primary-contrast));filter:drop-shadow(0 0 5px var(--ion-color-primary-contrast))}.labelbutton[_ngcontent-%COMP%]   fa-icon[_ngcontent-%COMP%]{color:var(--ion-background-color);font-size:24px}.labelbutton.playing[_ngcontent-%COMP%]{background-color:green}.labelbutton.recording[_ngcontent-%COMP%]{background-color:red}@media (orientation:portrait){app-swiper[_ngcontent-%COMP%]{margin-top:35px}}"],changeDetection:0}),ce),pe=["snippetel"];function fe(e,t){if(1&e&&(h.Nb(0,"div",5),h.Lb(1,"ion-icon",6),h.Mb()),2&e){var n=t.index,i=h.Xb();h.Bb("complete",i.session.stage>n),h.zb(1),h.cc("name",i.geticon(n))}}var me,be=((me=function(){function e(t,n,i){_classCallCheck(this,e),this.sesh=t,this.modalCtrl=n,this.tools=i,this.progIcons=["camera","mic-circle","help-circle","checkmark-circle"],this.openingmodal=!1,this.longpress=new h.n,this.activated=new Set}return _createClass(e,[{key:"ngOnInit",value:function(){this.imageStyle=this.sesh.getImageStyleFromId(this.session.coverId)}},{key:"ngAfterViewInit",value:function(){var e=this;console.log("el",this.snippetElement),this.alloy=new te.a(this.snippetElement.nativeElement,{tap:function(){e.click()},longTap:function(){e.longpress.emit()}})}},{key:"ngOnDestroy",value:function(){this.alloy.destroy()}},{key:"geticon",value:function(e){var t=this.progIcons[e];return this.session.stage<=e&&(t=t+="-outline"),t}},{key:"click",value:function(){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.openingmodal){e.next=16;break}if(this.openingmodal=!0,1!==this.session.stage){e.next=9;break}return e.next=4,this.modalCtrl.create({component:$,componentProps:{session:this.session}});case 4:return t=e.sent,e.next=7,this.tools.showModal(t);case 7:e.next=15;break;case 9:if(2!==this.session.stage){e.next=15;break}return e.next=12,this.modalCtrl.create({component:de,componentProps:{session:this.session}});case 12:return n=e.sent,e.next=15,this.tools.showModal(n);case 15:this.openingmodal=!1;case 16:case"end":return e.stop()}}),e,this)})))}}]),e}()).\u0275fac=function(e){return new(e||me)(h.Kb(c.a),h.Kb(i.x),h.Kb(l.a))},me.\u0275cmp=h.Eb({type:me,selectors:[["app-kitchen-snippet"]],viewQuery:function(e,t){var n;1&e&&h.sc(pe,!0),2&e&&h.fc(n=h.Wb())&&(t.snippetElement=n.first)},inputs:{session:"session",setac:"setac"},outputs:{longpress:"longpress"},decls:6,vars:5,consts:[[1,"snippet"],["snippetel",""],[1,"photo"],[1,"progressbar"],["class","progressitem",3,"complete",4,"ngFor","ngForOf"],[1,"progressitem"],["icon-only","",3,"name"]],template:function(e,t){if(1&e&&(h.Nb(0,"div",0,1),h.Lb(2,"div",2),h.Yb(3,"async"),h.Nb(4,"div",3),h.nc(5,fe,2,3,"div",4),h.Mb(),h.Mb()),2&e){var n,i=null==(n=h.Zb(3,3,t.imageStyle))?null:n.style;h.zb(2),h.mc("background-image",i,h.Db),h.zb(3),h.cc("ngForOf",t.progIcons)}},directives:[s.j,i.k],pipes:[s.b],styles:['.snippet[_ngcontent-%COMP%]{width:100%;height:120px;display:flex;flex-direction:row;padding:5px;--color-incomplete:var(--ion-color-primary);--color-complete:var(--ion-color-secondary);border-bottom:1px solid grey}.snippet[_ngcontent-%COMP%]   .photo[_ngcontent-%COMP%]{width:160px;border:1px solid rgba(0,0,0,.2);background-size:cover;background-position:50%;-webkit-filter:drop-shadow(-1px 1px 3px var(--ion-color-dark));filter:drop-shadow(-1px 1px 3px var(--ion-color-dark))}.snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:row}.snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]   .progressitem[_ngcontent-%COMP%]{width:25%;display:flex;align-items:center;justify-content:center;color:var(--ion-color-primary);position:relative;opacity:.6}.snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]   .progressitem[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{display:inline-block;font-size:36px}.snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]   .progressitem.complete[_ngcontent-%COMP%]{color:var(--ion-color-primary);opacity:1}.snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]   .progressitem.complete[_ngcontent-%COMP%]:not(:first-child):before, .snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]   .progressitem[_ngcontent-%COMP%]:not(.complete):not(:first-child):before{height:2px;background-color:var(--ion-color-primary);content:"";position:absolute;width:calc(100% - 26px);left:calc(-50% + 14px);z-index:-1}.snippet[_ngcontent-%COMP%]   .progressbar[_ngcontent-%COMP%]   .progressitem[_ngcontent-%COMP%]:not(.complete):not(:first-child):before{opacity:.8}.activated[_nghost-%COMP%]   .snippet[_ngcontent-%COMP%]{-webkit-filter:drop-shadow(0 0 5px red);filter:drop-shadow(0 0 5px red)}']}),me),ve=["fileinput"];function ye(e,t){if(1&e){var n=h.Ob();h.Nb(0,"app-kitchen-snippet",8),h.Vb("longpress",(function(){h.hc(n);var e=t.$implicit;return h.Xb().longpress(e.id)})),h.Mb()}if(2&e){var i=t.$implicit,s=h.Xb();h.Bb("activated",s.activated.has(i.id)),h.cc("session",i)}}function we(e,t){if(1&e){var n=h.Ob();h.Nb(0,"ion-fab",9),h.Nb(1,"ion-fab-button",3),h.Vb("click",(function(e){return h.hc(n),h.Xb().openActionSheet(e)})),h.Lb(2,"ion-icon",10),h.Mb(),h.Mb()}}var xe,Ce,ke,Pe=[{path:"",component:(xe=function(){function e(t,n,i,s,r){_classCallCheck(this,e),this.sessions=t,this.modalCtrl=n,this.tools=i,this.actionCtrl=s,this.popCtrl=r,this.activated=new Set,this.showMenu=!1,this.$sessionList=t.observeSessions()}return _createClass(e,[{key:"handleFiles",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.preventDefault(),0!==e.target.files.length){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,this.modalCtrl.create({component:y,componentProps:{files:e.target.files}});case 4:return n=t.sent,t.next=7,this.tools.showModal(n);case 7:if(i=t.sent,t.t0=i,!t.t0){t.next=12;break}return t.next=12,this.sessions.createSession(i.photos,i.coverIndex);case 12:case"end":return t.stop()}}),t,this)})))}},{key:"clickNew",value:function(){this.inputElement.nativeElement.click()}},{key:"longpress",value:function(e){this.activated.has(e)?this.activated.delete(e):this.activated.add(e),this.showMenu=Array.from(this.activated.values()).length>0}},{key:"openActionSheet",value:function(e){return Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,i=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.actionCtrl.create({header:"Sessions",cssClass:"my-custom-class",buttons:[{text:"Delete",role:"destructive",icon:"trash",handler:function(){return Object(a.__awaiter)(i,void 0,void 0,regeneratorRuntime.mark((function t(){var n,i,s,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("Delete clicked"),n=this.activated.size,i=n>1?"s":"",s="Delete "+n.toString()+" session"+i+"?",t.next=6,this.confirm(s,["Delete","Cancel"],e);case 6:if(r=t.sent,t.t0=r&&"Cancel"!==r,!t.t0){t.next=14;break}return console.log("deleting"),t.next=12,this.sessions.deleteSessions(Array.from(this.activated.values()));case 12:this.activated.clear(),this.showMenu=!1;case 14:case"end":return t.stop()}}),t,this)})))}},{text:"Cancel",icon:"close",role:"cancel",handler:function(){console.log("Cancel clicked"),i.activated.clear(),i.showMenu=!1}}]});case 2:return n=t.sent,t.next=5,n.present();case 5:case"end":return t.stop()}}),t,this)})))}},{key:"confirm",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2],Object(a.__awaiter)(this,void 0,void 0,regeneratorRuntime.mark((function n(){var i;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.popCtrl.create({component:C,componentProps:{text:e,options:t}});case 2:return i=n.sent,n.next=5,this.tools.showPopover(i);case 5:return n.abrupt("return",n.sent);case 6:case"end":return n.stop()}}),n,this)})))}}]),e}(),xe.\u0275fac=function(e){return new(e||xe)(h.Kb(c.a),h.Kb(i.x),h.Kb(l.a),h.Kb(i.a),h.Kb(i.z))},xe.\u0275cmp=h.Eb({type:xe,selectors:[["app-kitchen"]],viewQuery:function(e,t){var n;1&e&&h.lc(ve,!0),2&e&&h.fc(n=h.Wb())&&(t.inputElement=n.first)},decls:9,vars:4,consts:[[1,"scroller"],[3,"session","activated","longpress",4,"ngFor","ngForOf"],["vertical","bottom","horizontal","end","slot","fixed",1,"foo"],[3,"click"],["name","add-outline"],["vertical","bottom","horizontal","center","slot","fixed","class","foo",4,"ngIf"],["multiple","","type","file","name","name","accept","image/*",2,"display","none",3,"change"],["fileinput",""],[3,"session","longpress"],["vertical","bottom","horizontal","center","slot","fixed",1,"foo"],["name","ellipsis-vertical"]],template:function(e,t){1&e&&(h.Nb(0,"div",0),h.nc(1,ye,1,3,"app-kitchen-snippet",1),h.Yb(2,"async"),h.Mb(),h.Nb(3,"ion-fab",2),h.Nb(4,"ion-fab-button",3),h.Vb("click",(function(){return t.clickNew()})),h.Lb(5,"ion-icon",4),h.Mb(),h.Mb(),h.nc(6,we,3,0,"ion-fab",5),h.Nb(7,"input",6,7),h.Vb("change",(function(e){return t.handleFiles(e)})),h.Mb()),2&e&&(h.zb(1),h.cc("ngForOf",h.Zb(2,2,t.$sessionList)),h.zb(5),h.cc("ngIf",t.showMenu))},directives:[s.j,i.h,i.i,i.k,s.k,be],pipes:[s.b],styles:[".scroller[_ngcontent-%COMP%]{-webkit-overflow-scrolling:touch;-ms-overflow-style:none;scrollbar-width:none;overflow-y:scroll;color:#000;margin-bottom:30px}.scroller[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}ion-fab-button[_ngcontent-%COMP%]{--color:var(--ion-background-color)}"]}),xe)}],Me=((Ce=function e(){_classCallCheck(this,e)}).\u0275mod=h.Ib({type:Ce}),Ce.\u0275inj=h.Hb({factory:function(e){return new(e||Ce)},imports:[[o.i.forChild(Pe)],o.i]}),Ce),Oe=n("j1ZV"),Re=((ke=function e(){_classCallCheck(this,e)}).\u0275mod=h.Ib({type:ke}),ke.\u0275inj=h.Hb({factory:function(e){return new(e||ke)},imports:[[i.v,s.c,r.a,Me,Oe.a]]}),ke)},pooC:function(e,t,n){"use strict";t.Deferred=function(){function e(){var e=this;this.resolve=function(t){e._resolve(t)},this.reject=function(t){e._reject(t)},this._promise=new Promise((function(t,n){e._resolve=t,e._reject=n}))}return Object.defineProperty(e.prototype,"promise",{get:function(){return this._promise},enumerable:!0,configurable:!0}),e}()}}]);